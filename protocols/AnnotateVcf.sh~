#MOLGENIS walltime=05:59:00 mem=6gb ppn=10

#string caddAnnotationVcf
#string toCADD
#string fromCADD
#string projectBatchGenotypedVariantCalls
#string indexFile
#string htsLibVersion
#string vcfannoVersion
#string bcfToolsVersion

ml ${vcfannoVersion}
ml ${htsLibVersion}
ml ${BCFtools}


##create file toCADD
bcftools norm -f "${indexFile}" -m -any "${projectBatchGenotypedVariantCalls}" | awk '{if (!/^#/){if (length($4) > 1 || length($5) > 1){print $1"\t"$2"\t"$3"\t"$4"\t"$5}}}' | bgzip -c > "${toCADD}"

score.sh "${toCADD}" "${fromCADD}"

(echo -e '##fileformat=VCFv4.1\n##INFO=<ID=raw,Number=A,Type=Float,Description="raw cadd score">\n##INFO=<ID=phred,Number=A,Type=Float,Description="phred-scaled cadd score">\n##CADDCOMMENT=<ID=comment,comment="CADD v1.3 (c) University of Washington and Hudson-Alpha Institute for Biotechnology 2013-2015. All rights reserved.">\n#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO' && gzip -dc ${fromCADD}\
| awk '{if(NR>2){ printf $1"\t"$2"\t.\t"$3"\t"$4"\t1\tPASS\traw="; printf "%0.1f;",$5 ;printf "phred=";printf "%0.1f\n",$6}}') | bgzip -c > "${fromCADD}.vcf.gz"


bcftools norm -f "${indexFile}" -m +any "${fromCADD}.vcf.gz" > "${fromCADD}.merged.vcf"
bgzip -c "${fromCADD}.merged.vcf" > "${fromCADD}.merged.vcf.gz
tabix -p vcf "${fromCADD}.merged.vcf.gz"

cat <<EOF
[[annotation]]
file="${fromCADD}.merged.vcf.gz"
names=["CADD_SCALED","CADD"]
fields=["phred", "raw"]
ops=["self","self"]

[[annotation]]
file="${caddAnnotationVcf}"
names=["CADD_SCALED","CADD"]
fields=["phred", "raw"]
ops=["self","self"]
EOF >> ${projectBatchGenotypedVariantCalls%%.*}.conf.toml
./vcfanno_linux64 ${projectBatchGenotypedVariantCalls%%.*}.conf.toml ${projectBatchGenotypedVariantCalls} > ${projectBatchGenotypedVariantCalls}.annotated.vcf
